下面给你一份“RAG 里的切块（chunking）方法全景图 + 实战对比”。我把方法按“如何确定边界 & 如何组织层级”两条主线来梳理，并给出适用场景、典型超参、优缺点与工程注意点。📚

# 一、为什么切块很关键？

* 检索用的是“块”的向量，而不是整篇文档；块的边界决定了召回/精度、延迟、成本与幻觉率。
* 过大：召回容易，但噪声大、上下文挤爆；过小：定位准，但信息碎、需要拼装。
* “好块”的特征：**语义自洽**、**上下文充分**、**可追溯（位置信息）**、**可被模型在上下文窗内消费**。

---

# 二、方法总览（按“如何定边界”分类）

## 1) 固定长度切块（Fixed-size, 可选重叠）

* **做法**：按 token/字符等距切分；常配 `overlap`（如 256 长度+64 重叠）。
* **优点**：实现简单，吞吐高；对异构文档稳定；利于流式/并行索引。
* **缺点**：易割裂语义；重复索引（重叠）增成本。
* **典型超参**：200–400 tokens，15–30% overlap。
* **适用**：海量非结构文本、首版上线抢时间。

## 2) 句/段落打包（Sentence/Paragraph packing）

* **做法**：先句子分割（中文按 `。！？；` 等），再按“token 桶”打包至上限。
* **优点**：天然语义边界，噪声低；比固定长更“自洽”。
* **缺点**：段落极长时仍会被切断；对句界识别质量敏感。
* **适用**：说明文、报告、FAQ、博客等自然语料。

## 3) 递归/规则分割（Recursive/Separator-based）

* **做法**：按标题层级/分隔符（如 Markdown `#`, `##`, 列表、代码块）→ 不足/超限再细分。
* **优点**：尊重结构；和 Markdown/HTML 天然兼容。
* **缺点**：对“脏”文本（复制的网页/PDF 解析残缺）鲁棒性差。
* **适用**：技术文档、API 文档、Wiki、手册。

## 4) 语义切块（Semantic chunking / Topic segmentation）

* **做法**：用相邻句向量相似度、TextTiling/C99、BERT 相似度突变点做边界；或阈值/动态规划。
* **优点**：边界更贴近主题切换；减少跨主题污染。
* **缺点**：计算重、离线耗时；对域外语料可能失灵。
* **适用**：长报告、白皮书、论文、课堂讲义。

## 5) 版面/布局感知（Layout-aware）

* **做法**：PDF/Doc 解析出块：标题、段落、表格、图注、页眉页脚分离。
* **优点**：表格/图注不被打散；可分通道处理（表格→结构化）。
* **缺点**：解析成本高；版面错误会传染到索引。
* **适用**：PDF 报告、幻灯片、扫描件（配 OCR）。

## 6) 代码感知（Code-aware / AST-based）

* **做法**：以**函数/类/文件**为最小单元；过长再按语句块切；附上依赖/导入摘要。
* **优点**：语义自洽；利于“定位函数+给出上下文”。
* **缺点**：跨文件调用需要“父子检索”或引用追踪。
* **适用**：代码库问答/修复/审计。

## 7) 表格/结构化切块（Table-aware / Row-grouping）

* **做法**：整表为块（小表）；或按行/分区切，**重复 header** 作上下文；列加权。
* **优点**：避免“值失去列名”；支持“列筛选”检索。
* **缺点**：大表会指数膨胀；需专门检索器（BM25+结构）。
* **适用**：CSV/Excel、报告附表、财务/指标表。

## 8) 标题父子块（Parent–child / Section–passage）

* **做法**：索引“子块”（检索粒度）+ 存“父块”（注入上下文），命中子块时把父块一起交给 LLM。
* **优点**：**兼顾精度与上下文**；减少 overlap 依赖。
* **缺点**：存储翻倍；实现复杂度略高。
* **适用**：长章节文档、手册、书籍。

## 9) 分层/层级摘要（Hierarchical / RAPTOR 风格）

* **做法**：先底层切块→向上聚类/总结形成“概念/章节摘要节点”；检索先 coarse 再 fine。
* **优点**：长文全局检索更稳；多粒度证据融合。
* **缺点**：预处理重；摘要质量影响召回。
* **适用**：超长文档库、知识库门户、企业制度集。

## 10) 图谱/社区切块（Graph-based / 社区发现）

* **做法**：实体/主题为节点，文段关联成图；社群作为“块”；或给每个节点挂说明块。
* **优点**：跨文档主题联结强；利于多跳问答。
* **缺点**：构图成本高；更新维护复杂。
* **适用**：政策/法规/研究领域综述、企业知识图谱。

## 11) 查询时动态扩窗（Query-time expansion）

* **做法**：先命中一个小块，再向**左右扩展 N 个相邻块**或补充“同段其他句”。
* **优点**：无须在索引时重叠；按需拉上下文，降低噪声。
* **缺点**：查询时延略增；需要块序元数据。
* **适用**：对延迟不极敏感的问答检索。

## 12) 文档类型特化（FAQ/日志/工单）

* **FAQ**：一问一答=一块；**工单/日志**：按会话/时间窗口切；**合同/法条**：按条款、款项切。
* **优点**：任务贴合、效果显著。
* **缺点**：需要领域模板与抽取规则。

---

# 三、方法纵向对比（速览表）

| 方法      | 语义完整性 | 实施成本 | 检索精度 | 召回率  | 存储/索引成本  | 典型场景          |
| ------- | ----- | ---- | ---- | ---- | -------- | ------------- |
| 固定长度+重叠 | ★★    | ★    | ★★   | ★★★  | ★★☆（重叠↑） | 首版、海量文本       |
| 句/段落打包  | ★★★   | ★★   | ★★★  | ★★☆  | ★★       | 一般文档          |
| 递归/规则分割 | ★★★   | ★★   | ★★★  | ★★☆  | ★★       | Markdown/HTML |
| 语义切块    | ★★★☆  | ★★★  | ★★★☆ | ★★★  | ★★★      | 长报告/论文        |
| 布局感知    | ★★★   | ★★★  | ★★★  | ★★☆  | ★★☆      | PDF/表格/图文     |
| 代码感知    | ★★★☆  | ★★★  | ★★★☆ | ★★   | ★★       | 代码问答          |
| 表格切块    | ★★★   | ★★☆  | ★★★  | ★★   | ★★☆～★★★  | 表格检索          |
| 父子块     | ★★★☆  | ★★☆  | ★★★☆ | ★★★  | ★★★      | 长章节知识         |
| 分层/摘要   | ★★★   | ★★★  | ★★★  | ★★★☆ | ★★★      | 超长库           |
| 图谱切块    | ★★★   | ★★★  | ★★★  | ★★★  | ★★★      | 多跳/跨文档        |
| 动态扩窗    | ★★★   | ★★   | ★★★  | ★★★  | ★★       | 需要低噪上下文       |

（★ 越多越好；成本多星=更高）

---

# 四、超参与工程建议（按任务给出“即插即用配置”）

## A. 通用知识问答（中文/英文混合）

* **切块**：句/段落打包 → 上限 300–400 tokens；**overlap 15–20%**（如句跨界时生效）。
* **检索**：向量检索 + MMR 去冗（相似度 0.2–0.4）；k=8–12；**父子块**开启（父=小节）。
* **元数据**：`doc_id, section_id, chunk_id, start_idx, end_idx, page, heading_path`。

## B. PDF 报告/论文

* **切块**：布局感知：标题/段落/图表分通道；**表格单独存储**（行分块+重复表头）。
* **补强**：每个一级/二级标题生成 1–2 句**层级摘要**（做“门牌号”）。
* **检索**：先召回摘要/标题块，再回溯底层块。

## C. 代码库

* **切块**：函数/类为块；超长函数再按语句块 200–300 tokens；附上导入/调用摘要。
* **检索**：向量 + 关键字（符号名）混合；命中子块→携带**同文件上下 1–2 块**。

## D. FAQ/知识库

* **切块**：Q\&A 一对一；**别重叠**。
* **检索**：可加稠密+稀疏融合（BM25 + 向量）；k=5–8 即可。

---

# 五、评估：怎么比较谁更好？

**两层指标**：

1. **检索层**：Recall\@k、nDCG\@k、MRR、覆盖率（命中包含答案的块比例）。
2. **生成层**：答案 F1/EM、是否引用正确证据、幻觉率、人评可用性。

**A/B 方案**：

* 固定长度(256/20% overlap) vs 句打包(≤350 tokens) vs 语义切块(≤350)。
* **持平条件**：相同向量模型、相同 k、相同 rerank。
* **观察**：

  * 块越大 → Recall↑、Precision↓、延迟↑、上下文挤占↑。
  * 适度 overlap（15–25%）常对**跨句查询**有益；>35% 通常“性价比”走低。
  * 父子块常带来 **+2～5 pp 的最终回答正确率**（视文档粒度而定）。

---

# 六、常见坑 & 规避清单

* **跨主题拼接**：固定长度在话题边界切裂；用句打包/语义边界替代。
* **页眉页脚噪声**：PDF 抽取先清洗；把页码、水印单独当噪声域。
* **表头丢失**：表格分块必须复制 header；否则值语义丢失。
* **代码割裂**：不要把函数一半切在前一块、一半切在后一块。
* **tokenizer 不一致**：嵌入模型与 LLM tokenizer 不同会出现“名义 300，实际 500”的偏差；应按嵌入模型的 tokenizer 计数。
* **过度重叠**：索引体积、召回重复、rerank 负担暴涨。
* **只看 embedding**：很多场景 BM25/稀疏特征对**数字/符号**更敏感；建议混合检索。

---

# 七、推荐落地配方（你可以直接照做）

**“通用中文/英文知识库”**：

1. 预处理：去重、清洗页眉/脚注、抽表格与图注。
2. 切块：**句/段落打包至 320 tokens，上限 360，overlap 15%**；Markdown/HTML 用分隔符优先。
3. 父子设计：子=段落块，父=二级标题范围；命中子→携父；父长 ≤ 1k tokens。
4. 辅助：为每个一级/二级标题生成 1–2 句摘要，单独入库（便于 coarse 检索）。
5. 检索：向量（k=10）+ BM25 融合；用 MMR 或多样性重排；再用 cross-encoder rerank top 50→top 8。
6. 评估：构建 100–300 条标注问答，做切块/检索/RAG 端到端 A/B。

---

# 八、简短结论 & 选型建议

* **第一优先**：句/段落打包 + 适度 overlap（15–20%），作为“务实默认”。
* **文档很长/层级明显**：配 **父子块** + **层级摘要**。
* **PDF/图表密集**：用 **布局感知**；表格分块时**重复表头**。
* **代码**：函数/类为块，必要时加“同文件邻域扩窗”。
* **时间/成本紧**：先固定长度上马，后续再迭代为语义/结构化切块。


